# Dreamheart 引擎 - 模块更新标准作业程序 (SOP) (v1.5 - 核心戒律强化)

## 1. 目的 (Purpose)

本文档定义了使用"LLM 开发助手"安全地迭代和更新 Dreamheart 引擎模块的标准作业程序 (SOP)。

其核心目的是确保 LLM 在执行任何（由 planning 文件定义的）更新任务时，同时具备"全局结构视野"和"严格的工程戒律"，以维护项目的健壮性和一致性。

## 2. 核心资产 (Core Assets)

此工作流依赖于我们已创建的三个核心"上下文资产"：

* **`prompt_context_map.xml` (全局地图)**

  * **职责:** "WHAT IT IS" (它是什么？)

  * **提供:** 引擎的全局 Schema、模块职责 (role) 和依赖关系 (depends_on)。

* **`prompt_update_guidelines.xml` (更新戒律)**

  * **职责:** "HOW TO DO IT" (如何安全地做？)

  * **提供:** LLM 助手在编辑 XML 时必须遵守的"工程最佳实践"（如：转义、Fragment 包装器、属性化原则）。

* **`planning.md` (或 .txt) (更新计划)**

  * **职责:** "WHAT TO DO NOW" (现在要做什么？)

  * **提供:** 本次迭代的具体任务列表（如："在 \[模块A\] 中增加 \[功能X\]"）。这是一个动态文件，每次任务都会变化。

## 2.5 \[v1.5 新增\] ‼️ 绝对核心戒律 (Absolute Core Mandates) ‼️

在开始任何更新之前，LLM 助手和人类开发者都必须牢记以下两条**绝对核心戒律**，以避免最常见且最致命的错误：

1. **戒律一：文件完整性至上 (File Integrity is Paramount)**

   * **‼️ 绝对禁止 ‼️** LLM 助手在交付产出物时，使用任何形式的代码片段、省略号 (`...`)、`<!-- ... existing code ... -->` 注释或 diff 格式。

   * **要求：** 任何被修改的目标文件，其**【完整内容】**必须被输出。

   * **原因：** 这是确保 XML 绝对有效、避免开发者手动合并引入错误、保证 `xml_validator.py` 和 `merge_prompt.py` 能直接处理输出的**唯一**方法。不完整的输出是导致验证失败和构建错误的**首要原因**。

2. **戒律二：模板与实例的严格区分 (Template vs. Instance Distinction)**

   * **定义：**

     * **模板文件 (Template Files):** 指那些定义 Schema、规则或指令的文件（如 `5_ConsolidatedMemory.xml`, `genesis_prompt.xml`, `Scribe.xml`）。它们的作用是**定义结构和行为**，必须保持**绝对通用**。

     * **实例数据 (Instance Data):** 指由“创世”AI 根据玩家剧本生成，或由“史官”AI 根据游戏历史更新的具体内容（如 NPC 的名字、对话、压力值、具体的风格词汇）。

   * **‼️ 绝对禁止 ‼️** 在任何“模板文件”中包含任何“实例数据”或可能产生引导/污染作用的具体示例（尤其是名词、描述性词汇）。

   * **原因：** “模板文件”必须保持绝对通用，以适应任何玩家输入；“实例数据”会破坏通用性，导致 AI 在生成或更新时产生严重错误和逻辑混乱。将实例硬编码到模板中是**第二大常见错误**。

## 3. 更新工作流 (Update Workflow)

1. **人类 (开发者):** 创建一个临时的 `planning.md` 文件，清晰描述本次的更新需求。**\[v1.4 优化\]** 建议按文件修改顺序组织任务。

2. **人类 (开发者):** 确定需要被编辑的"目标文件"（例如 `3a_CoreMechanics.xml`）。

3. **人类 (开发者):** 向 LLM 助手发起一个"驱动 Prompt"（见第 4 节），该 Prompt 必须包含上述三个"核心资产"以及"目标文件"作为其完整的上下文。

4. **LLM (助手):** 严格遵循"驱动 Prompt"的指示，执行 `planning.md` 中的任务，并**牢记 \[第 2.5 节\] 的两大核心戒律**。

5. **LLM (助手):** 交付两个产出物：

   * **a. \[产出物 1\]** 更新后的"目标文件"的**【完整】**内容。

     * **‼️ 绝对核心戒律 ‼️** 再次强调：必须是**【完整文件内容】**。**【绝对禁止】**使用任何代码片段、省略号 (`...`)、`<!-- ... existing code ... -->` 或 diff 格式。请参考 \[第 2.5 节 戒律一\]。

   * **b. \[产出物 2\]** 一份"依赖关系报告"（基于 DependencyAwareness 指令）。

6. **人类 (开发者): \[步骤 A: 单元校验\]**

   * 对 LLM 交付的 \[产出物 1\] (例如 3a_new.xml) 运行 `xml_validator.py`。

   * **\[路径 B: 校验失败\]**

     * 如果校验失败，停止工作流。跳转到 \[第 5 节: 错误修正SOP\]。

   * **\[路径 A: 校验成功\]**

     * 如果校验成功，继续下一步。

7. **人类 (开发者): \[步骤 B: 集成验证\]**

   * （这是在单次更新任务完成（并通过单元校验）后执行的"构建"步骤。）

   * 运行 `prompt/merge_prompt.py` 脚本，对**所有**模块（包括刚更新的 \[产出物 1\]）进行完整的本地集成验证，以确保这个改动没有破坏"全局构建"。如果合并失败，请参考 \[第 5 节\] 的思路进行调试。

8. **人类 (开发者): \[v1.4 新增步骤 C: 全局地图同步\]**

   * 在完成所有模块文件的修改并通过集成验证后，**必须** review `prompt/prompt_context_map.xml`。

   * **确认**该文件是否需要更新，以准确反映本次修改引入的架构变化、职责调整或新的依赖关系。

   * 如果需要更新，开发者应**发起一个新的任务**（或自行修改），确保全局地图与代码保持同步。这是维护LLM助手未来工作准确性的关键。

## 4. \[关键\] 驱动 Prompt 示例 (Driver Prompt Example)

这是人类开发者向 LLM 助手发起更新任务时，应使用的标准"驱动 Prompt"模板。

```
你好，LLM 开发助手。

你的任务是协助我执行一次 Dreamheart 引擎的模块更新。

你必须严格按照一个"上下文包" (Context Package) 来执行任务。任何未包含在此包中的信息都应被忽略。

### ‼️ 绝对核心戒律 (Absolute Core Mandates) ‼️

在你开始之前，请务必再次阅读并牢记 `prompt_update_SOP.md` [第 2.5 节] 中定义的两大核心戒律：
1.  **文件完整性至上：【绝对禁止】** 输出任何不完整的文件内容（片段、省略号、diff 等）。
2.  **模板与实例区分：【绝对禁止】** 在模板文件中硬编码实例数据或引导性示例。

### 你的"上下文包" (Context Package)

1.  **[本次的任务 (WHAT TO DO)]: `planning.md`**
    * 这是本次更新的"工单"。你必须严格执行其中描述的任务。
    * 此文件也定义了你的"执行权" (Write Access)。如果它说"只许修改 [文件A]"，你就绝不能修改 [文件B]。

2.  **[要编辑的文件 (TARGET)]: `[例如: 3a_CoreMechanics.xml]`**
    * 这是你唯一被授权*修改*的文件。
    * 你必须在响应中输出此文件的**【完整】**更新后内容。
        * **‼️ 绝对核心戒律 ‼️** 再次强调：必须是**【完整文件内容】**。**【绝对禁止】**任何代码片段或省略格式。违反此戒律将导致校验失败！请参考 `prompt_update_SOP.md` [第 2.5 节 戒律一]。

3.  **[工程戒律 (HOW TO DO IT)]: `prompt_update_guidelines.xml`**
    * 这是你的"宪法"。在编辑 [TARGET] 文件时，你必须 100% 严格遵守此文件中的**所有** `<Directive>` 指令（包括 `StrictXMLRules` 和 `SchemaBestPractices`）。

4.  **[全局地图 (WHAT IT IS)]: `prompt_context_map.xml`**
    * 这是你的"全局视野"。你必须使用此文件来理解 [TARGET] 文件在整个引擎中的位置、职责 (role) 和依赖关系 (depends_on)。

### 执行流程 (Execution Flow)

你必须严格按照以下步骤思考和行动：

1.  **理解核心戒律:** 再次确认你已理解 `prompt_update_SOP.md` [第 2.5 节] 的两大核心戒律。
2.  **理解任务:** 详细阅读 **[本次的任务] (`planning.md`)**。
3.  **理解工程戒律:** 详细阅读 **[工程戒律] (`prompt_update_guidelines.xml`)**。
4.  **理解全局:** 详细阅读 **[全局地图] (`prompt_context_map.xml`)**。
5.  **执行修改:**
    * 打开 **[要编辑的文件] (`[...].xml`)**。
    * 严格遵循 **[工程戒律]** 中的所有规范（如 `Escaping`, `Fragment` 包装器, `Attribute-ization`, **注释位置规范**）。
    * 严格遵循 **[核心戒律二]**：如果你在编辑的是“模板文件”，**【绝对禁止】**包含任何“实例数据”或引导性示例。
    * 参考 **[全局地图]** 提供的上下文。
    * 执行 **[本次的任务]** 中描述的修改。

6.  **交付产出物 1:** 输出你修改后的 **[要编辑的文件] (`[...].xml`)** 的**【完整】**内容。
    * **‼️ 绝对核心戒律 ‼️** 最后确认：输出的是**【完整文件内容】**，没有任何省略。

### 报告责任 (Reporting Duty)

在你交付产出物 1 之后，你必须（作为你响应的第二部分）执行 `prompt_update_guidelines.xml` 中的 `DependencyAwareness` 指令：

1.  **重新检查** **[全局地图] (`prompt_context_map.xml`)**。
2.  **主动报告:** 向我（人类）提供一份"依赖关系报告"，说明你刚才的修改（根据 `depends_on` 属性）可能会对哪些其他模块产生影响，并建议我在未来的 `planning` 中考虑它们。

请开始执行。

```

## 5. \[后处理\] 错误修正 SOP (SOP-Post)

此节对应于"第 3 节：更新工作流"中的 \[3.6. 路径 B: 校验失败\]。

如果 `xml_validator.py` 报告了致命的 XML 格式错误，人类开发者必须使用以下（精简后的）"错误修正驱动 Prompt"模板，向 LLM 助手发起一个"调试任务"。

```
你好，LLM 开发助手。

你上次生成的 `[...].xml` 文件未能通过 `xml_validator.py` 的严格校验。

你的**唯一任务**是：**调试并修正这个致命的 XML 格式错误**。

### ‼️ 核心戒律复核 ‼️
在开始调试前，请务必复核 `prompt_update_SOP.md` [第 2.5 节] 的两大核心戒律：
1.  **文件完整性：** 你上次是否输出了**【完整】**的文件内容？
2.  **模板 vs 实例：** 你上次是否在“模板文件”中错误地包含了“实例数据”？

### [关键] 调试提示 (来自我们的"艰巨任务")
* 验证器日志（尤其是行号）**可能具有误导性！**
* 你**不能**只看行号，你**必须**结合 [工程戒律] (`prompt_update_guidelines.xml`) 和 [核心戒律] (`prompt_update_SOP.md`) 来诊断*真正的*"错误类型"（例如："诊断：文件完整性" 或 "诊断：模板中含实例数据" 或 "诊断：非法转义" 或 "诊断：缺少 <Fragment> 包装器" 或 "诊断：注释位置错误"）。

### 你的"上下文" (Context)
1.  **[戒律 (RULES)]: `prompt_update_guidelines.xml`**
    * (你必须加载此文件。错误的根源 100% 在于违反了此文件中的某条 `<Directive>`)
2.  **[核心戒律 (CORE RULES)]: `prompt_update_SOP.md`**
    * (你必须加载此文件，尤其是 [第 2.5 节]，以诊断核心错误)
3.  **[失败的文件 (TARGET)]: `[..._BROKEN.xml]`**
    * (这是你上次生成失败的**【完整】**文件)
4.  **[错误日志 (EVIDENCE)]: `validator_error.log`**
    * (这是 `xml_validator.py` 输出的错误日志原文)

### 你的"交付物" (Deliverables)
1.  **[产出物 1]:** 修正后的 **[失败的文件]** 的**【完整】**内容。
    * **‼️ 绝对核心戒律 ‼️** 确保这次是**【完整文件】**！
2.  **[产出物 2]:** 简要说明你诊断出的根本原因，以及你是如何根据 [戒律] 和 [核心戒律] 修正它的。
---
**(请人类开发者在这里粘贴 `xml_validator.py` 的完整输出，例如：)**
============================================================ XML 格式验证工具 v1.0
🔍 验证文件: prompt/3a_CoreMechanics.xml
...
错误位置上下文:
109:
110:  <!-- ... IntentOrientedInputSystem ... -->
111:  &lt;IntentOrientedInputSystem title= "意图导向型输入系统 " &gt;
...
============================================================
📋 验证结果:
============================================================
❌ 致命错误: 发现多个根元素。
---
请开始执行修正。

```