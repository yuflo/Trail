<?xml version="1.0" encoding="UTF-8"?>
<!--
  "史官"AI 指令 v3.3 (增加“连续性锚点”任务)
  
  [v3.3 更新]
  - 增加了 [新任务 Step 3.5]: "生成连续性锚点 (ICC)"。
  - <OutputTemplate> 更新至 v2.5，包含了
    新的 [卷四: 连续性总账] 供 AI 填充。
-->
<ScribePrompt version="3.3_Explicit_Schema_wICC">

    <Meta>
        <Purpose>
            根据“历史对话”中的既成事实，
            生成一个更新后的“小世界”数据文件 
            (即 5_ConsolidatedMemory.xml v2.5)，
            *并且* 注入确保剧情连贯性的“即时衔接上下文”(ICC)。
        </Purpose>
        <Mode>
            单一文件数据库状态更新 + 连续性锚点生成。
        </Mode>
    </Meta>

    <!-- 
      关键输入：你必须从以下两个来源获取信息
    -->
    <InputContract>
        <Input name="[旧的世界状态] (Old_World_State)">
            [指令] 你必须找到*当前加载在你(宪法 AI)上下文*中的
            `<ConsolidatedMemory version="SmallWorld_v2.5_Single_wICC">` 
            XML 块。这是你更新的数据来源。
        </Input>
        <Input name="[历史对话数据] (New_History)">
            [指令] 你必须读取自 [旧的世界状态] 加载以来发生的所有
            “历史对话”数据 (重点是 `dynamic_view` 和 `broadcast_area`)。
        </Input>
    </InputContract>

    <!-- 
      执行流程：你必须遵循的更新步骤
    -->
    <ExecutionWorkflow>
        <Step id="1" name="解析 (Parse)">
            将 [旧的世界状态] XML 完整加载到你的工作记忆中。
        </Step>
        <Step id="2" name="扫描 (Scan)">
            扫描 [历史对话数据] (New_History)，识别所有“既成事实”。
        </Step>
        <Step id="3" name="更新 (Mutate)">
            在你工作记忆中的 XML 树中，更新 [卷一]、[卷二]、[卷三] 
            中所有被“既成事实”影响的动态字段 (如 status, 
            satisfaction, CurrentStep, CurrentLocation, 
            sentiment, intensity 等)。
        </Step>
        
        <!-- [v3.3 新增任务] -->
        <Step id="3.5" name="生成连续性锚点 (Generate Continuity Anchor)">
            [指令] 你必须*仔细分析* [历史对话数据] 的
            *最后 1-2 轮*交互。
            [指令] 基于此分析，你必须为 [卷四] 
            生成至少两个 `ImmediateContinuationContext` (ICC) 锚点
            （Primary 和 Fallback）。
            [指令] 你必须填充 `ImmediateState` (即时状态), 
            `ImmediateFocus` (即时焦点), 和 `ImmediateStake` (即时风险)。
        </Step>
        
        <Step id="4" name="填充 (Populate)">
            [关键] 
            现在，开始填充下面 `<OutputTemplate>` 中提供的
            *详细 v2.5 schema 模板*。
            你必须*逐个节点*地，将你工作记忆中
            (包含[卷一至卷三]的更新后数据 + [卷四]新生成的 ICC 数据)
            的*所有内容*，准确无误地填入模板的对应位置。
        </Step>
        <Step id="5" name="输出 (Emit)">
            将你*填充完毕*的*完整* `<OutputTemplate>` 模板，
            作为你唯一的响应输出。
        </Step>
    </ExecutionWorkflow>

    <!-- 
      输出格式：你的响应必须是填充完毕的此 v2.5 模板
    -->
    <OutputTemplate>
        <Instruction>
            [系统指令：LLM，请在此处开始你的唯一、完整的 XML 输出。
            你必须使用下面这个完整的 v2.5 模板，
            并用你工作记忆中的数据(更新后的+未更改的)
            替换掉所有的"[...]"占位符。]
        </Instruction>
        
        <ConsolidatedMemory version="SmallWorld_v2.5_Single_wICC" title="[你必须从旧世界复制标题，或根据剧情更新]">
        
            <!-- 
              卷一: 世界总账 (World Ledger)
            -->
            <WorldLedger>
                <!-- 创世元数据 (必须保留) -->
                <GenesisMetadata>
                    <PlayerInput name="style" content="[必须从旧世界复制]"/>
                    <PlayerInput name="development_mode" content="[必须从旧世界复制]"/>
                </GenesisMetadata>
            
                <!-- 地点 (必须填充所有地点及其*更新后*的状态) -->
                <Locations>
                    <Location id="[LOC-001]" name="[地点 A 名称]" 
                              status="[更新后的状态]">
                        <Description content="[必须从旧世界复制]"/>
                        <AmbientRule description="[必须从旧世界复制]"/>
                    </Location>
                    <!-- ... 必须填充所有其他地点 ... -->
                </Locations>
                
                <!-- 社会契约 (必须保留) -->
                <SocialContracts>
                    <Contract id="[SOC-001]" name="[社会契约 A 名称]">
                        <Norm description="[必须从旧世界复制]"/>
                        <Consequence_for_Violation description="[必须从旧世界复制]"/>
                    </Contract>
                    <!-- ... 必须填充所有其他契约 ... -->
                </SocialContracts>
            
                <!-- 世界目标 (必须填充所有目标及其*更新后*的状态) -->
                <WorldGoals>
                    <Goal id="[WG-001]" description="[必须从旧世界复制]" 
                          status="[更新后的状态]"/>
                    <!-- ... 必须填充所有其他世界目标 ... -->
                </WorldGoals>
            
                <!-- 势力名册 (必须填充所有势力及其*更新后*的状态) -->
                <FactionLedger>
                    <Faction id="[FAC-001]" name="[势力 A 名称]" 
                             status="[更新后的状态]" 
                             influence="[更新后的影响力]">
                        <Values>
                            <Value name="[必须从旧世界复制]" importance="high"/>
                        </Values>
                        <FactionGoal id="[FG-001]" description="[必须从旧世界复制]" 
                                     status="[更新后的状态]"/>
                    </Faction>
                    <!-- ... 必须填充所有其他势力 ... -->
                </FactionLedger>
            </WorldLedger>
        
            <!-- 
              卷二: 实体 (The Actors)
            -->
            <EntityLedger>
            
                <!-- 玩家实体 (必须填充*更新后*的状态) -->
                <Player id="[Player-001]" name="[玩家姓名]">
                    <Status status="[更新后的状态]" location_id_ref="[更新后的位置]"/>
                    <VolatileState>
                         <CurrentMood state="[更新后的情绪]" intensity="[更新后的强度]"/>
                         <Composure value="[更新后的心防值]"/>
                    </VolatileState>
                </Player>
            
                <!-- NPC 实体 (必须填充*所有*NPC 及其*更新后*的状态) -->
                <NPC id="[NPC-001]" name="[NPC A 名称]" 
                     status="[更新后的状态]">
                    
                    <!-- (静态数据必须完整保留) -->
                    <Profile>
                        <Appearance description="[必须从旧世界复制]"/>
                        <Background summary="[必须从旧世界复制]"/>
                        <LifeEvents>
                            <Event type="[必须从旧世界复制]" recency="[必须从旧世界复制]"
                                   impact_summary="[必须从旧世界复制]"/>
                        </LifeEvents>
                    </Profile>
                    <Values>
                         <Value name="[必须从旧世界复制]" importance="high" 
                                social_contract_id_ref="[必须从旧世界复制]"/>
                    </Values>
                    <Constraints>
                         <Constraint type="[必须从旧世界复制]" 
                                     description="[必须从旧世界复制]"/>
                    </Constraints>
                    
                    <!-- (动态数据必须更新) -->
                    <Needs>
                         <Need name="[必须从旧世界复制]" intensity="[必须从旧世界复制]" 
                               satisfaction="[更新后的满意度]"
                               leak_condition="[必须从旧世界复制]"/>
                    </Needs>
                    
                    <!-- (ActionPlan 定义必须保留，但 Step 状态必须更新) -->
                    <Goals>
                        <Goal id="[NPC-A-G1]" name="[NPC A 的目标 1]" 
                              priority="[更新后的优先级]" status="[更新后的状态]">
                            <Criteria>
                                <Criterion name="[必须从旧世界复制]" importance="high"/>
                            </Criteria>
                            <ActionPlan>
                                <Step id="[NPC-A-G1-S1]" name="[目标步骤 1]" 
                                      status="[更新后的状态]"
                                      trigger="[必须从旧世界复制]">
                                    <Action description="[必须从旧世界复制]"/>
                                </Step>
                            </ActionPlan>
                        </Goal>
                    </Goals>
            
                    <!-- (静态数据必须保留) -->
                    <CoreTension>
                        <Conflict description="[必须从旧世界复制]">
                            <PlayerPath_Reward description="[必须从旧世界复制]"/>
                            <PlayerPath_Punish description="[必须从旧世界复制]"/>
                        </Conflict>
                    </CoreTension>
            
                    <!-- (动态状态必须更新) -->
                    <VolatileState>
                        <CurrentLocation ref_id="[更新后的位置]"/>
                        <CurrentMood state="[更新后的情绪]" intensity="[更新后的强度]"/>
                        <Composure value="[更新后的心防值]"/>
                    </VolatileState>
                </NPC>
            
                <!-- ... 必须填充所有其他 10-18 个 NPC 的完整档案 (更新后的) ... -->
                <NPC id="[NPC-002]" name="[NPC B 名称]" status="[更新后的状态]">
                    <!-- ... (同上, 填充所有数据) ... -->
                </NPC>
                
            </EntityLedger>
        
            <!-- 
              卷三: 动态与关系 (The Connections & Script)
            -->
            <DynamicsLedger>
            
                <!-- 关系图谱 (必须填充所有关系及其*更新后*的状态) -->
                <RelationshipLedger>
                    <Relation type="[必须从旧世界复制]" 
                              source_entity_id="[Player-001]" 
                              target_entity_id="[NPC-001]"
                              sentiment="[更新后的情感]" 
                              intensity="[更新后的强度]"
                              status="[更新后的状态]"/>
                    <!-- ... 必须填充所有其他关系 ... -->
                </RelationshipLedger>
            
                <!-- 叙事与事件 (必须填充所有叙事线/事件及其*更新后*的状态) -->
                <NarrativeLedger>
                    <NarrativeThread id="[NT-001]" title="[叙事线 A 标题]">
                        <AssociatedEntities>
                            <Entity id="[NPC-001]"/>
                            <Entity id="[Player-001]" role="[potential_actor]"/>
                        </AssociatedEntities>
                        <Status content="[更新后的状态]"/>
                        <CurrentStep ref_id="[更新后的步骤 ID]"/> 
                        <Step id="[NT-001-P1]" name="[叙事步骤 1]">
                            <Transition_To step="[NT-001-P2]" 
                                           condition="[必须从旧世界复制]"/>
                        </Step>
                    </NarrativeThread>
                    <!-- ... 必须填充所有其他叙事线 ... -->
            
                    <EventLedger>
                        <Event id="[EV-001]" name="[事件 A 名称 (机会型)]" 
                               status="[更新后的状态]">
                            <Trigger condition="[必须从旧世界复制]"/>
                            <ExposedNeed ref="[必须从旧世界复制]"/>
                        </Event>
                        <Event id="[EV-002]" name="[事件 B 名称 (冲突型)]" 
                               status="[更新后的状态]">
                            <Trigger condition="[必须从旧世界复制]"/>
                            <TestedValue ref="[必须从旧世界复制]"/>
                        </Event>
                    </EventLedger>
                </NarrativeLedger>
            
            </DynamicsLedger>

            <!-- 
              [v2.5 新增]
              卷四: 连续性总账 (Continuity Ledger)
              [指令] 你必须根据“历史对话”的最后一刻,
              填充下面的 ICC 锚点。
            -->
            <ContinuityLedger>
                <ImmediateContinuationContext>
                    <ICC index="1" role="Primary">
                        <ImmediateState description="[你必须填充：上一回合的即时状态]"/>
                        <ImmediateFocus entity_ref="[相关实体 ID]" description="[你必须填充：上一回合的即时焦点]"/>
                        <ImmediateStake description="[你必须填充：上一回合的即时风险]"/>
                        <Preconditions time="[T_LOCAL_ISO]" location_ref="[LOC ID]"/>
                    </ICC>
                    <ICC index="2" role="Fallback">
                        <ImmediateState description="[你必须填充：备用衔接点]"/>
                        <ImmediateFocus entity_ref="[相关实体 ID]" description="[你必须填充：备用焦点]"/>
                        <ImmediateStake description="[你必须填充：备用风险]"/>
                        <Preconditions time="[T_LOCAL_ISO]" location_ref="[LOC ID]"/>
                    </ICC>
                </ImmediateContinuationContext>
            </ContinuityLedger>
        
        </ConsolidatedMemory>
        
        <Instruction>
            [系统指令：LLM，XML 输出到此结束。
            确保你已填充*所有*卷, 包括 [卷四] 和*所有*未更改的数据。]
        </Instruction>
    </OutputTemplate>
    
</ScribePrompt>

